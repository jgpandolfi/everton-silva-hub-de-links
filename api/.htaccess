# ----------------- CONFIGURAÇÕES ESSENCIAIS -----------------
# Ativar o motor de reescrita
RewriteEngine On

# Bloquear acesso a arquivos sensíveis
<FilesMatch "^(\.htaccess|config\.php|funcoes\.php|\.env)">
    Require all denied
</FilesMatch>

# ----------------- SEGURANÇA AVANÇADA -----------------
# Desativar listagem de diretórios
Options -Indexes

# Headers de segurança
Header set X-Content-Type-Options "nosniff"
Header set X-Frame-Options "DENY"
Header set X-XSS-Protection "1; mode=block"
Header set Referrer-Policy "strict-origin-when-cross-origin"

# ----------------- CORS E API - MODIFICADO -----------------
# Configuração CORS mais flexível
Header always set Access-Control-Allow-Origin "https://evertonsilvaoficial.com.br"
Header always set Access-Control-Allow-Methods "POST, OPTIONS, GET"
Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
Header always set Access-Control-Allow-Credentials "true"
Header always set Vary "Origin"

# Permitir pré-flight requests
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=200,L]

# ----------------- CONFIGURAÇÕES PHP -----------------
# Garantir que o header Authorization seja passado para o PHP
SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1

# Configurações específicas para a API
php_value session.cookie_httponly 1
php_value session.cookie_secure 1
php_value session.use_strict_mode 1
php_flag expose_php Off
php_value error_reporting 1
php_flag display_errors On
php_flag log_errors On
php_value error_log "../api_errors.log"

# ----------------- PERMITIR PROCESSAMENTO DE FORMULÁRIO -----------------
# Garantir acesso ao endpoint de processamento de formulário
<Files "processar-formulario.php">
    Require all granted
    SetEnvIf Origin "https://evertonsilvaoficial\.com\.br" IS_CORS=1
    Header always set Access-Control-Allow-Origin "https://evertonsilvaoficial.com.br" env=IS_CORS
</Files>

# ----------------- LIMITAR MÉTODOS HTTP -----------------
# Permitir apenas POST e OPTIONS para endpoints da API
<LimitExcept POST OPTIONS GET>
    Require all denied
</LimitExcept>

# ----------------- FORÇAR HTTPS -----------------
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ----------------- PÁGINAS DE ERRO PERSONALIZADAS -----------------
ErrorDocument 400 /erros/400.php
ErrorDocument 401 /erros/401.php
ErrorDocument 403 /erros/403.php
ErrorDocument 404 /erros/404.php
ErrorDocument 500 /erros/500.php